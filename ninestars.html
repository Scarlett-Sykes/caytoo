<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Signal Table</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    #brandModal { 
      display: none; 
      position: fixed; 
      top: 20%; left: 30%; 
      background: white; 
      padding: 20px; 
      border: 1px solid #333; 
    }
    #dateFilter { margin-bottom: 15px; }
    button { margin-right: 5px; }
  </style>
</head>
<body>

<h2>Signals</h2>

<div id="dateFilter">
  <label for="signalDate">Select Date:</label>
  <input type="date" id="signalDate">
  <button onclick="loadSignalsByDate()">Get Signals</button>
  <button onclick="loadSignals()">Get Last 5 Days</button>
</div>

<table id="signalsTable">
  <thead>
    <tr>
      <th>Signal ID</th>
      <th>Brand ID</th>
      <th>Brand Name</th>
      <th>Subcategory</th>
      <th>HQ</th>
      <th>Type</th>
      <th>Summary</th>
      <th>Date</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="brandModal">
  <form id="brandForm">
    <input type="hidden" name="brandId">
    <label>Region: <input type="text" name="region"></label><br>
    <label>Country: <input type="text" name="country"></label><br>
    <label>City: <input type="text" name="city"></label><br>
    <label>Summary: <textarea name="summary"></textarea></label><br>
    <button type="submit">Save</button>
    <button type="button" onclick="closeBrandModal()">Cancel</button>
  </form>
</div>

<script>
let signals = [];

const WEBHOOK_URL = "https://caytoo-ops-n8n.bravepond-37f4561a.ukwest.azurecontainerapps.io/webhook-test/fetch-signals";

// Safe trim helper
function safeTrim(value) { return value ? value.trim() : ''; }

// Populate table
function populateTable(signals) {
  const tbody = document.querySelector('#signalsTable tbody');
  tbody.innerHTML = '';
  signals.forEach(signal => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${signal.SignalID || ''}</td>
      <td>${signal.BrandID || ''}</td>
      <td>${signal.BrandName || ''}</td>
      <td>${signal.Subcategory || ''}</td>
      <td>${signal.HQ || ''}</td>
      <td>${signal.SignalType || ''}</td>
      <td>${signal.Summary || ''}</td>
      <td>${signal.SignalDate || ''}</td>
      <td>
        <button onclick="openBrandModal(${signal.BrandID})">Validate Brand</button>
        <button onclick="dismissSignal(${signal.BrandID})">Dismiss</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Fetch last 5 days (GET)
async function loadSignals() {
  console.log("Fetching last 5 days...");
  try {
    const response = await fetch(WEBHOOK_URL);
    const data = await response.json();
    console.log("Signals fetched:", data);
    signals = data;
    populateTable(signals);
  } catch (err) {
    console.error("Error fetching last 5 days:", err);
  }
}

// Fetch signals for a specific date (POST)
async function loadSignalsByDate() {
  const dateInput = document.getElementById('signalDate').value;
  if (!dateInput) {
    alert("Please select a date");
    return;
  }

  console.log("Fetching signals for date:", dateInput);

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ date: dateInput })
    });
    const data = await response.json();
    console.log("Signals fetched for date:", data);
    signals = data;
    populateTable(signals);
  } catch (err) {
    console.error("Error fetching signals by date:", err);
  }
}

// Open modal
function openBrandModal(brandId) {
  const signal = signals.find(s => s.BrandID === brandId);
  if (!signal) return;

  const form = document.getElementById('brandForm');
  form.brandId.value = signal.BrandID || '';
  form.region.value = safeTrim(signal.Region);
  form.country.value = safeTrim(signal.Country);
  form.city.value = safeTrim(signal.City);
  form.summary.value = signal.Summary || '';

  document.getElementById('brandModal').style.display = "block";
}

// Close modal
function closeBrandModal() { document.getElementById('brandModal').style.display = "none"; }

// Submit validation
document.getElementById('brandForm').onsubmit = async function(e) {
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form));

  try {
    await fetch('https://caytoo-ops-n8n.bravepond-37f4561a.ukwest.azurecontainerapps.io/webhook-test/update-brand', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    // Remove validated signal
    signals = signals.filter(s => s.BrandID !== data.brandId);
    populateTable(signals);
    closeBrandModal();
  } catch (err) {
    console.error("Error validating brand:", err);
  }
};

// Dismiss signal
async function dismissSignal(brandId) {
  try {
    await fetch('https://caytoo-ops-n8n.bravepond-37f4561a.ukwest.azurecontainerapps.io/webhook-test/dismiss-signal', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ brandId })
    });

    signals = signals.filter(s => s.BrandID !== brandId);
    populateTable(signals);
  } catch (err) {
    console.error("Error dismissing signal:", err);
  }
}

// Initial load
loadSignals();
</script>

</body>
</html>
