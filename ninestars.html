<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Signal Table</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Montserrat', sans-serif;
    background-image: url('caytoo_Report cover template V2.png');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center 20%;
    color: #333;
    margin: 0;
    padding: 0;
  }
  h2 {
    color: white;
    width: 800px;
    margin: 20px auto;
    text-align: left;
  }

  /* Date selector */
  #dateFilter {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto 30px auto;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: rgba(255,255,255,0.9);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  #dateFilter input[type="date"] {
    height: 36px;
    padding: 4px 8px;
    font-size: 14px;
  }
  #dateFilter button {
    height: 36px;
    font-size: 14px;
    padding: 0 12px;
    border-radius: 9999px;
    border: none;
    cursor: pointer;
    background: linear-gradient(180deg, #FF5476, #FF5156);
    color: white;
    transition: opacity 0.3s ease;
  }
  #dateFilter button:hover { opacity: 0.9; }

  /* Filters */
  #filters {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto 30px auto;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: rgba(255,255,255,0.9);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  #filters input, #filters select, #filters button {
    font-size: 14px;
    height: 36px;
    padding: 4px 8px;
  }

  /* Table */
  table {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto 30px auto;
    border-collapse: collapse;
    background-color: rgba(255,255,255,0.9);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  th, td {
    padding: 8px;
    font-size: 14px;
    vertical-align: top;
  }
  th { background-color: #f4f4f4; text-align: left; }
  td .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px 8px;
  }
  td .grid div { font-size: 12px; color: #555; }
  td .summary { margin-top: 4px; font-weight: normal; }

  /* Modal */
  #brandModal {
    display: none;
    position: fixed;
    top: 5%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 1000;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
  }
  input[type="text"], input[type="url"], textarea, select {
    width: 100%;
    padding: 6px 8px;
    font-size: 14px;
    margin-bottom: 10px;
    box-sizing: border-box;
  }
  .custom-submit-btn {
    font-weight: bold;
    padding: 8px 16px;
    border-radius: 9999px;
    font-size: 14px;
    cursor: pointer;
    border: none;
    background: linear-gradient(180deg, #FF5476, #FF5156);
    color: white;
    transition: opacity 0.3s ease;
    margin-right: 6px;
  }
  .custom-submit-btn:hover { opacity: 0.9; }
</style>
</head>
<body>

<h2>Signals</h2>

<!-- Date Selector -->
<div id="dateFilter">
  <label for="signalDate">Date:</label>
  <input type="date" id="signalDate">
  <button onclick="loadSignalsByDate()">Go</button>
  <button onclick="loadSignals()">Last 5 Days</button>
</div>

<!-- Filters -->
<div id="filters">
  <label>Subcategory:
    <select id="filterSubcategory"><option value="">All</option></select>
  </label>
  <label>HQ:
    <input type="text" id="filterHQ" placeholder="City or Country">
  </label>
  <button onclick="applyFilters()">Apply Filters</button>
  <button onclick="clearFilters()">Clear</button>
</div>

<!-- Table -->
<table id="signalsTable">
  <thead>
    <tr>
      <th>Summary & Info</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div id="brandModal">
  <form id="brandForm">
    <input type="hidden" name="brandId">
    <label>Brand Name: <input type="text" name="brandName" required></label>
    <label>URL: <input type="url" name="url"></label>
    <label>About: <textarea name="about"></textarea></label>
    <label>Subcategory:
      <select name="subcategory" id="subcategorySelect"></select>
    </label>
    <label>City: <input type="text" name="city"></label>
    <label>Region: <input type="text" name="region"></label>
    <label>Country: <input type="text" name="country"></label>
    <label>Revenue: <input type="text" name="revenue"></label>
    <button type="submit" class="custom-submit-btn">Validate</button>
    <button type="button" class="custom-submit-btn" onclick="closeBrandModal()">Cancel</button>
  </form>
</div>

<script>
const WEBHOOK_FETCH = "https://caytoo-ops-n8n.bravepond-37f4561a.ukwest.azurecontainerapps.io/webhook-test/fetch-signals";
const WEBHOOK_UPDATE = "https://caytoo-ops-n8n.bravepond-37f4561a.ukwest.azurecontainerapps.io/webhook-test/update-brand";

let signals = [];

const subcategories = [
"Auto Components & Tyres","Auto Manufacturer","Auto Retail","Accessories & Watches (CG)","Clothing/Apparel (CG)",
"Electronics/Appliances (CG)","Home/Garden (CG)","Household Goods","Personal Goods","Gambling","Non-profit",
"Online Delivery Service","Restaurants & Bars","Specialised Consumer Service","Education","Banks","Crypto/Blockchain",
"Insurance","Investment/Trading","Loans","Payments/Transfer","Alcohol","Foods","Nutrition & Supplements",
"Soft Drinks","Health Service","Health/Sports Product","Pharmaceuticals","Sport/Leisure Facility","Agricultural/Food",
"Construction","Manufacturing/Engineering","Materials/Chemicals","Cybersecurity","IT Services/Hardware","Software",
"Broadcasting","Games","Music/Audio","Publishing","Consultancy/Tax","Legal","Recruitment/HR","Specialist Professional Service",
"Estate Agency","Property Development","Accessories & Watches (R)","Clothing/Apparel (R)","Electronics/Appliances (R)",
"General Retail","Grocery Retail","Home/Garden (R)","Speciality Retail","Landline Telecoms","Mobile Telecoms",
"Telecoms Infrastructure","Logistics","Ports & Marine","Rail & Road","Hotels & Cruise Lines","Airlines","Attractions",
"Tourist Board","Travel Agency","Energy","Water"
];

// Set default date = yesterday
function setDefaultDate(){
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate()-1);
  document.getElementById('signalDate').value = yesterday.toISOString().slice(0,10);
}
setDefaultDate();

// Populate Subcategory filter dropdown
const filterSubcategorySelect = document.getElementById('filterSubcategory');
subcategories.forEach(sc=>{
  const opt=document.createElement('option');
  opt.value=sc;
  opt.textContent=sc;
  filterSubcategorySelect.appendChild(opt);
});

// Populate table
function populateTable(signals){
  const tbody=document.querySelector('#signalsTable tbody');
  tbody.innerHTML='';
  signals.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>
        <div class="grid">
          <div><strong>HQ:</strong> ${s.HQ||''}</div>
          <div><strong>Type:</strong> ${s.SignalType||''}</div>
          <div><strong>Subcategory:</strong> ${s.Subcategory||''}</div>
          <div><strong>Date:</strong> ${s.SignalDate||''}</div>
        </div>
        <div class="summary">${s.Summary||''}</div>
      </td>
      <td>
        <button class="custom-submit-btn" onclick="openBrandModal(${s.BrandID})">Validate Brand</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Load signals (last 5 days)
async function loadSignals(){
  try{
    const res=await fetch(WEBHOOK_FETCH);
    signals=await res.json();
    populateTable(signals);
  }catch(err){console.error(err);}
}

// Load signals by specific date
async function loadSignalsByDate(){
  const dateInput=document.getElementById('signalDate').value;
  if(!dateInput){ alert("Please select a date"); return; }
  try{
    const res=await fetch(WEBHOOK_FETCH,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({date:dateInput})
    });
    signals=await res.json();
    populateTable(signals);
  }catch(err){console.error(err);}
}

// Modal functions
function openBrandModal(brandId){
  const signal = signals.find(s => s.BrandID === brandId);
  if(!signal) return;

  const form = document.getElementById('brandForm');
  form.brandId.value = signal.BrandID || '';
  form.brandName.value = signal.BrandName || '';
  form.url.value = signal.URL || '';
  form.about.value = signal.About || '';
  form.city.value = signal.City || '';
  form.region.value = signal.Region || '';
  form.country.value = signal.Country || '';
  form.revenue.value = signal.RevenueUSD || '';

  const select = document.getElementById('subcategorySelect');
  select.innerHTML = '';

  // Pre-select current subcategory
  const currentOpt = document.createElement('option');
  currentOpt.value = signal.Subcategory || '';
  currentOpt.textContent = signal.Subcategory || 'Select Subcategory';
  currentOpt.selected = true;
  select.appendChild(currentOpt);

  // Add other subcategories except current one
  subcategories.filter(sc => sc !== signal.Subcategory)
               .forEach(sc => {
    const opt = document.createElement('option');
    opt.value = sc;
    opt.textContent = sc;
    select.appendChild(opt);
  });

  document.getElementById('brandModal').style.display = "block";
}

function closeBrandModal(){
  document.getElementById('brandModal').style.display = "none";
}

// Submit brand form
document.getElementById('brandForm').onsubmit = async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));

  try {
    const res = await fetch(WEBHOOK_UPDATE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      signals = signals.filter(s => String(s.BrandID) !== String(data.brandId));
      populateTable(signals);
      closeBrandModal();
    } else {
      const errorMsg = await res.text();
      console.error("Webhook returned an error:", errorMsg);
      alert("Failed to validate brand: " + (errorMsg || "Unknown error"));
    }
  } catch (err) {
    console.error("Network error:", err);
    alert("Error submitting brand. Please try again.");
  }
};

// Filters functions
function applyFilters() {
  const selectedSubcategory = filterSubcategorySelect.value;
  const hqFilter = document.getElementById('filterHQ').value.toLowerCase();

  const filteredSignals = signals.filter(s => {
    const matchesSubcategory = selectedSubcategory ? s.Subcategory === selectedSubcategory : true;
    const matchesHQ = hqFilter ? ((s.HQ||'').toLowerCase().includes(hqFilter)) : true;
    return matchesSubcategory && matchesHQ;
  });

  populateTable(filteredSignals);
}

function clearFilters() {
  filterSubcategorySelect.value = '';
  document.getElementById('filterHQ').value = '';
  populateTable(signals);
}

// Initial load
loadSignals();
</script>
</body>
</html>
