<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Signal Table</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    #brandModal { 
      display: none; 
      position: fixed; 
      top: 20%; left: 30%; 
      background: white; 
      padding: 20px; 
      border: 1px solid #333; 
    }
    #dateFilter { margin-bottom: 15px; }
    button { margin-right: 5px; }
  </style>
</head>
<body>

<h2>Signals</h2>

<div id="dateFilter">
  <label for="signalDate">Select Date:</label>
  <input type="date" id="signalDate">
  <button onclick="loadSignalsByDate()">Get Signals</button>
  <button onclick="loadSignals()">Get Last 5 Days</button>
</div>

<table id="signalsTable">
  <thead>
    <tr>
      <th>Signal ID</th>
      <th>Brand ID</th>
      <th>Type</th>
      <th>Summary</th>
      <th>Region</th>
      <th>Country</th>
      <th>City</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="brandModal">
  <form id="brandForm">
    <input type="hidden" name="brandId">
    <label>Region: <input type="text" name="region"></label><br>
    <label>Country: <input type="text" name="country"></label><br>
    <label>City: <input type="text" name="city"></label><br>
    <label>Summary: <textarea name="summary"></textarea></label><br>
    <button type="submit">Save</button>
    <button type="button" onclick="closeBrandModal()">Cancel</button>
  </form>
</div>

<script>
let signals = []; // global array to hold current signals

// Helper to safely trim strings
function safeTrim(value) {
  return value ? value.trim() : '';
}

// Populate table with signals
function populateTable(signals) {
  const tbody = document.querySelector('#signalsTable tbody');
  tbody.innerHTML = '';

  signals.forEach(signal => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${signal.intSignalId || ''}</td>
      <td>${signal.intbrandId || ''}</td>
      <td>${signal.strSignalType || ''}</td>
      <td>${signal.strSignalSummary || ''}</td>
      <td>${safeTrim(signal.strBrandRegion)}</td>
      <td>${signal.strCountry || ''}</td>
      <td>${signal.strCity || ''}</td>
      <td>
        <button onclick="openBrandModal(${signal.intbrandId})">Validate Brand</button>
        <button onclick="dismissSignal(${signal.intbrandId})">Dismiss</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Fetch last 5 days signals (GET)
async function loadSignals() {
  try {
    const response = await fetch('https://<your-n8n-webhook>/fetch-signals');
    signals = await response.json();
    populateTable(signals);
  } catch (err) {
    console.error('Error fetching signals:', err);
  }
}

// Fetch signals by specific date (POST)
async function loadSignalsByDate() {
  const dateInput = document.getElementById('signalDate').value;
  if (!dateInput) {
    alert('Please select a date');
    return;
  }

  try {
    const response = await fetch('https://<your-n8n-webhook>/fetch-signals', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ date: dateInput })
    });
    signals = await response.json();
    populateTable(signals);
  } catch (err) {
    console.error('Error fetching signals by date:', err);
  }
}

// Open modal to edit brand
function openBrandModal(brandId) {
  const signal = signals.find(s => s.intbrandId === brandId);
  if (!signal) return;

  const form = document.getElementById('brandForm');
  form.brandId.value = signal.intbrandId || '';
  form.region.value = safeTrim(signal.strBrandRegion);
  form.country.value = signal.strCountry || '';
  form.city.value = signal.strCity || '';
  form.summary.value = signal.strSignalSummary || '';

  document.getElementById('brandModal').style.display = 'block';
}

// Close modal
function closeBrandModal() {
  document.getElementById('brandModal').style.display = 'none';
}

// Submit updated brand info (Validate)
document.getElementById('brandForm').onsubmit = async function(e) {
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form));

  try {
    await fetch('https://<your-n8n-webhook>/update-brand', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    // Remove validated signal from table
    signals = signals.filter(s => s.intbrandId !== data.brandId);
    populateTable(signals);

    closeBrandModal();
  } catch (err) {
    console.error('Error updating brand:', err);
  }
};

// Dismiss a signal
async function dismissSignal(brandId) {
  try {
    await fetch('https://<your-n8n-webhook>/dismiss-signal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ brandId })
    });

    // Remove dismissed signal from table
    signals = signals.filter(s => s.intbrandId !== brandId);
    populateTable(signals);
  } catch (err) {
    console.error('Error dismissing signal:', err);
  }
}

// Initial load: last 5 days
loadSignals();
</script>

</body>
</html>
