<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Signal Table</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Montserrat', sans-serif;
    background-image: url('caytoo_Report cover template V2.png');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center 20%;
    color: #333;
    margin: 0;
    padding: 0;
  }

  h2 {
    color: white;
    width: 90%;
    max-width: 1200px;
    margin: 20px auto;
    text-align: left;
  }

  /* Date selector */
  #dateFilter {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto 20px auto;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: rgba(255,255,255,0.9);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    flex-wrap: wrap;
  }

  #dateFilter input[type="date"] {
    height: 36px;
    padding: 4px 8px;
    font-size: 14px;
  }

    .btn {
      padding: 5px 8px;
      font-size: 14px;
      height: 28px;
      width: 100px; 
      border-radius: 9999px;
      cursor: pointer;
      border: none;
      color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: opacity 0.3s ease, transform 0.1s ease;
    }
    
    /* Primary buttons (Go, Last 5 Days, Apply, Clear) */
    .primary-btn {
      background: linear-gradient(180deg, #FF5476, #FF5156);
    }
    .primary-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    /* Secondary buttons (Dismiss/Flag) */
    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
      width: 80px; /* <-- added semicolon */
      border-radius: 9999px; /* keeps pill shape */
      cursor: pointer;
      border: none;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: opacity 0.3s ease, transform 0.1s ease;
    }
    

    .other-btn { background: #FF7F7F; } /* red-ish */
  
    .btn-small:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }
    
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 4px; /* vertical spacing between Validate and row below */
    }
    
    /* Row for Dismiss / Flag buttons */
    .secondary-buttons-row {
      display: flex;
      gap: 4px; /* space between Dismiss and Flag */
      width: 100%;
    }
    
    .secondary-buttons-row .btn-small {
      flex: 1; /* each takes 50% of row */
      height: 28px;
      padding: 4px 0;
      font-size: 12px;
    }

  /* Filters */
  #filters {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto 20px auto;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    background-color: rgba(255,255,255,0.9);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    flex-wrap: wrap;
  }
  #filters label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
  }
  #filters input, #filters select {
    font-size: 14px;
    height: 36px;
    padding: 4px 8px;
  }
  #signalCount {
    margin-left: auto;
    font-weight: bold;
    color: #FF5156;
  }

  /* Table */
  table {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto 30px auto;
    border-collapse: collapse;
    background-color: rgba(255,255,255,0.9);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  th, td {
    padding: 8px;
    font-size: 14px;
    vertical-align: top;
  }
  th { background-color: #f4f4f4; text-align: left; }
  td .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px 8px;
  }
  td .grid div { font-size: 12px; color: #555; }
  td .summary { margin-top: 4px; font-weight: normal; }

  /* Modal */
  #brandModal {
    display: none;
    position: fixed;
    top: 5%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 1000;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
  }

  input[type="text"], input[type="url"], textarea, select {
    width: 100%;
    padding: 6px 8px;
    font-size: 14px;
    margin-bottom: 10px;
    box-sizing: border-box;
  }
</style>
</head>
<body>

<h2>Signals</h2>

<!-- Date Selector -->
<div id="dateFilter">
  <label for="signalDate">Date:</label>
  <input type="date" id="signalDate">
  <button class="btn primary-btn" onclick="loadSignalsByDate()">Go</button>
  <button class="btn primary-btn" onclick="loadSignals()">Last 5 Days</button>
</div>

<!-- Filters -->
<div id="filters">
  <label>Subcategory:
    <select id="filterSubcategory"><option value="">All</option></select>
  </label>
  <label>HQ:
    <input type="text" id="filterHQ" placeholder="City or Country">
  </label>
  <button class="btn primary-btn" onclick="applyFilters()">Apply Filters</button>
  <button class="btn primary-btn" onclick="clearFilters()">Clear</button>
  <span id="signalCount">0 Signals</span>
</div>

<!-- Table -->
<table id="signalsTable">
  <thead>
    <tr>
      <th>Summary & Info</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div id="brandModal">
  <form id="brandForm">
    <input type="hidden" name="brandId">
    <label>Brand Name: <input type="text" name="brandName" required></label>
    <label>URL: <input type="url" name="url"></label>
    <label>About: <textarea name="about"></textarea></label>
    <label>Subcategory:
      <select name="subcategory" id="subcategorySelect" required></select>
    </label>
    <label>City: <input type="text" name="city"></label>
    <label>Region: <input type="text" name="region"></label>
    <label>Country: <input type="text" name="country"></label>
    <label>Revenue: <input type="text" name="revenue"></label>
    <button type="submit" class="btn">Validate</button>
    <button type="button" class="btn" onclick="closeBrandModal()">Cancel</button>
  </form>
</div>

<script>
/** Adjust these if your working endpoints are the -test ones */
const WEBHOOK_FETCH  = "https://caytoo-ops-n8n.bravepond-37f4561a.ukwest.azurecontainerapps.io/webhook/fetch-signals";
const WEBHOOK_UPDATE = "https://caytoo-ops-n8n.bravepond-37f4561a.ukwest.azurecontainerapps.io/webhook/update-brand";

let signals = [];

const subcategories = [
"Auto Components & Tyres","Auto Manufacturer","Auto Retail","Accessories & Watches (CG)","Clothing/Apparel (CG)",
"Electronics/Appliances (CG)","Home/Garden (CG)","Household Goods","Personal Goods","Gambling","Non-profit",
"Online Delivery Service","Restaurants & Bars","Specialised Consumer Service","Education","Banks","Crypto/Blockchain",
"Insurance","Investment/Trading","Loans","Payments/Transfer","Alcohol","Foods","Nutrition & Supplements",
"Soft Drinks","Health Service","Health/Sports Product","Pharmaceuticals","Sport/Leisure Facility","Agricultural/Food",
"Construction","Manufacturing/Engineering","Materials/Chemicals","Cybersecurity","IT Services/Hardware","Software",
"Broadcasting","Games","Music/Audio","Publishing","Consultancy/Tax","Legal","Recruitment/HR","Specialist Professional Service",
"Estate Agency","Property Development","Accessories & Watches (R)","Clothing/Apparel (R)","Electronics/Appliances (R)",
"General Retail","Grocery Retail","Home/Garden (R)","Speciality Retail","Landline Telecoms","Mobile Telecoms",
"Telecoms Infrastructure","Logistics","Ports & Marine","Rail & Road","Hotels & Cruise Lines","Airlines","Attractions",
"Tourist Board","Travel Agency","Energy","Water"
];

// Default date = yesterday
function setDefaultDate(){
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate()-1);
  document.getElementById('signalDate').value = yesterday.toISOString().slice(0,10);
}
setDefaultDate();

// Populate Subcategory filter dropdown
const filterSubcategorySelect = document.getElementById('filterSubcategory');
subcategories.forEach(sc=>{
  const opt=document.createElement('option');
  opt.value=sc;
  opt.textContent=sc;
  filterSubcategorySelect.appendChild(opt);
});

function updateSignalCount(count){
  document.getElementById('signalCount').textContent = `${count} Signal${count!==1?'s':''}`;
}

// Populate table
function populateTable(list){
  const tbody=document.querySelector('#signalsTable tbody');
  tbody.innerHTML='';
  list.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>
        <div class="grid">
          <div><strong>HQ:</strong> ${s.HQ||''}</div>
          <div><strong>Type:</strong> ${s.SignalType||''}</div>
          <div><strong>Subcategory:</strong> ${s.Subcategory||''}</div>
          <div><strong>Date:</strong> ${s.SignalDate||''}</div>
        </div>
        <div class="summary">${s.Summary||''}</div>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn primary-btn" onclick="openBrandModal(${s.BrandID})">Validate</button>
          <div class="secondary-buttons-row">
            <button class="btn-small other-btn" onclick="dismissSignal(${s.BrandID})">Dismiss</button>
            <button class="btn-small other-btn" onclick="flagSignal(${s.BrandID})">Flag</button>
          </div>
        </div>
      </td>


    `;
    tbody.appendChild(tr);
  });
  updateSignalCount(list.length);
}

// Event delegation for validate buttons (handles string/number BrandID)
document.addEventListener('click', (e) => {
  if (e.target.matches('.validate-btn')) {
    const brandId = e.target.dataset.brandid;
    openBrandModal(brandId);
  }
});

// Load signals (last 5 days)
async function loadSignals(){
  try{
    const res=await fetch(WEBHOOK_FETCH);
    signals=await res.json();
    populateTable(signals);
  }catch(err){console.error(err);}
}

// Load signals by specific date
async function loadSignalsByDate(){
  const dateInput=document.getElementById('signalDate').value;
  if(!dateInput){ alert("Please select a date"); return; }
  try{
    const res=await fetch(WEBHOOK_FETCH,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({date:dateInput})
    });
    signals=await res.json();
    populateTable(signals);
  }catch(err){console.error(err);}
}

// Modal functions
function openBrandModal(brandId){
  const signal = signals.find(s => String(s.BrandID) === String(brandId));
  if(!signal) return;

  const form = document.getElementById('brandForm');
  form.brandId.value = signal.BrandID || '';
  form.brandName.value = signal.BrandName || '';
  form.url.value = signal.URL || '';
  form.about.value = signal.About || '';
  form.city.value = signal.City || '';
  form.region.value = signal.Region || '';
  form.country.value = signal.Country || '';
  form.revenue.value = signal.Revenue || '';

  const select = document.getElementById('subcategorySelect');
  select.innerHTML = '';
  // placeholder shows current subcategory (not disabled so it's valid if they keep it)
  const placeholderOption = document.createElement('option');
  placeholderOption.value = signal.Subcategory || '';
  placeholderOption.textContent = signal.Subcategory || 'Select Subcategory';
  placeholderOption.selected = true;
  select.appendChild(placeholderOption);

  subcategories.forEach(sc => {
    const opt = document.createElement('option');
    opt.value = sc;
    opt.textContent = sc;
    // avoid duplicating current value at top
    if (sc !== signal.Subcategory) select.appendChild(opt);
  });

  document.getElementById('brandModal').style.display = "block";
}
function closeBrandModal(){
  document.getElementById('brandModal').style.display = "none";
}

// Submit brand form
document.getElementById('brandForm').onsubmit = async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));

  try {
    const res = await fetch(WEBHOOK_UPDATE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      // Remove validated brand from the list
      signals = signals.filter(s => String(s.BrandID) !== String(data.brandId));
      populateTable(signals);
      closeBrandModal();
    } else {
      const errorMsg = await res.text();
      console.error("Webhook error:", errorMsg);
      alert("Failed to validate brand: " + (errorMsg || "Unknown error"));
    }
  } catch (err) {
    console.error("Network error:", err);
    alert("Error submitting brand. Please try again.");
  }
};

  async function dismissSignal(brandId) {
  try {
    // Send to webhook for dismissed signals
    await fetch('https://caytoo-ops-n8n.bravepond-37f4561a.ukwest.azurecontainerapps.io/webhook/dismiss-signal', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ brandId })
    });

    // Optionally, mark it locally as dismissed to hide it immediately
    signals = signals.filter(s => s.BrandID !== brandId);
    populateTable(signals);

  } catch(err) {
    console.error("Error dismissing signal:", err);
    alert("Failed to dismiss signal. Try again.");
  }
}

async function flagSignal(brandId) {
  try {
    // Send to webhook for flagged signals
    await fetch('https://caytoo-ops-n8n.bravepond-37f4561a.ukwest.azurecontainerapps.io/webhook/flag-merge', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ brandId })
    });

    // Optionally, remove it from the local list so it disappears
    signals = signals.filter(s => s.BrandID !== brandId);
    populateTable(signals);

  } catch(err) {
    console.error("Error flagging signal:", err);
    alert("Failed to flag signal. Try again.");
  }
}


// Filters
function applyFilters() {
  const selectedSubcategory = filterSubcategorySelect.value;
  const hqFilter = document.getElementById('filterHQ').value.toLowerCase();

  const filteredSignals = signals.filter(s => {
    const matchesSubcategory = selectedSubcategory ? s.Subcategory === selectedSubcategory : true;
    const matchesHQ = hqFilter ? ((s.HQ||'').toLowerCase().includes(hqFilter)) : true;
    return matchesSubcategory && matchesHQ;
  });

  populateTable(filteredSignals);
}
function clearFilters() {
  filterSubcategorySelect.value = '';
  document.getElementById('filterHQ').value = '';
  populateTable(signals);
}

// Initial load
loadSignals();
</script>
</body>
</html>
